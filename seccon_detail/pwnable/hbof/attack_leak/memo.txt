ãƒ»å®Ÿè¡Œçµæœ
UAF
heap base : 0x7f4e76a3b5f0
libc base : 0x7f4e768500e0

Uninitialized
heap base : 0x7f4e76a3b5f0
libc base : 0x7f4e768500e0

ãƒ»è§£èª¬
ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€glibcã®mallocã®å®Ÿè£…ï¼ˆptmallocï¼‰ã«é–¢ã™ã‚‹çŸ¥è­˜ã‚’æ´»ç”¨ã—ã¦ã€ãƒ’ãƒ¼ãƒ—ã‚„libcã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒªãƒ¼ã‚¯ã™ã‚‹ãƒ‡ãƒ¢ã§ã™ã€‚
æ”»æ’ƒè¦–ç‚¹ã§ã®Use-After-Freeï¼ˆUAFï¼‰ã‚„Uninitializedãƒ’ãƒ¼ãƒ—ã®æŒ™å‹•ã‚’åˆ©ç”¨ã—ã¦ã€heap baseã‚„libc baseã®æ¨å®šãŒã§ãã‚‹ã‹ã‚’ç¢ºã‹ã‚ã¦ã„ã¾ã™ã€‚

ğŸ” ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã®è§£èª¬
â—† malloc_struct.h

glibcã®malloc_chunkæ§‹é€ ä½“ï¼ˆptmallocã§ä½¿ã‚ã‚Œã‚‹å†…éƒ¨æ§‹é€ ï¼‰ã®æ“¬ä¼¼å®šç¾©ã§ã™ã€‚

typedef struct malloc_chunk {
  size_t prev_size; // å‰ã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºï¼ˆæœªä½¿ç”¨æ™‚ï¼‰
  size_t size;      // ã“ã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã¨ãƒ•ãƒ©ã‚°ï¼ˆin-use ãªã©ï¼‰

  union {
    struct {
      struct malloc_chunk* fd; // free listä¸Šã®å‰å¾Œãƒã‚¤ãƒ³ã‚¿
      struct malloc_chunk* bk;
      struct malloc_chunk* fd_nextsize; // large binç”¨
      struct malloc_chunk* bk_nextsize;
    };
    char mem[0x20]; // ã‚µã‚¤ã‚ºåˆã‚ã›ã€‚fd/bkç­‰ã¯æœ€å¤§0x20ãƒã‚¤ãƒˆ
  };
} malloc_chunk;

ãƒã‚¯ãƒ­:

#define chunk2mem(p)   ((void*)(p)+0x10)
#define mem2chunk(mem) ((malloc_chunk*)((void*)(mem)-0x10))

ãƒãƒ£ãƒ³ã‚¯ã®useré ˜åŸŸã¨chunkãƒ˜ãƒƒãƒ€ã¨ã®ç›¸äº’å¤‰æ›ç”¨ã€‚glibcã§ã¯ã€ãƒãƒ£ãƒ³ã‚¯ãƒ˜ãƒƒãƒ€ã¯ãƒ¦ãƒ¼ã‚¶é ˜åŸŸã®ç›´å‰ï¼ˆé€šå¸¸16ãƒã‚¤ãƒˆå‰ï¼‰ã«ã‚ã‚Šã¾ã™ã€‚
â—† attack_leak.c

ãƒ’ãƒ¼ãƒ—ã®ãƒãƒ£ãƒ³ã‚¯æ“ä½œã‚’é€šã˜ã¦heap baseã¨libc baseã‚’æ¨å®šã™ã‚‹å®Ÿé¨“ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚
ã€å‰åŠã®å‹•ä½œã€‘

ma = malloc(MALLOC_SIZE);  // ãƒãƒ£ãƒ³ã‚¯Aç¢ºä¿
ca = mem2chunk(ma);        // ãƒãƒ£ãƒ³ã‚¯Aã®ãƒ˜ãƒƒãƒ€ã‚’å¾—ã‚‹
malloc(0);                 // â€»ç†ç”±ã¯å¾Œè¿°
free(ma);                  // ãƒãƒ£ãƒ³ã‚¯Aã‚’free

// æƒ…å ±ãƒªãƒ¼ã‚¯
printf("heap base : %p\n",   (void*)ca->bk - 0x6d0);
printf("libc base : %p\n", (void*)ca->fd - 0x60 - ofs_libc_mainarena);

    maã‚’freeã™ã‚‹ã¨ã€ãƒãƒ£ãƒ³ã‚¯AãŒunsorted binã«å…¥ã‚‹ã€‚

    ca->fd / ca->bkã«ã¯main_arenaæ§‹é€ ä½“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå…¥ã‚‹ãŸã‚ã€libc baseã‚’æ¨å®šã§ãã‚‹ã€‚

    heap baseã¯bkã‹ã‚‰ç®—å‡ºï¼ˆã“ã®0x6d0ã¯ãƒ’ãƒ¼ãƒ—ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼‰ã€‚

    malloc(0)ã¯glibcã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ˆã‚Šé‡è¦ã€‚
    glibc 2.29ä»¥é™ã§ã¯ã€freeç›´å¾Œã«main_arenaã‹ã‚‰fd/bkãŒä¸Šæ›¸ãã•ã‚Œãªã„ã‚ˆã†æœ€åˆã®mallocã§arenaãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ã“ã“ã§dummyã®malloc(0)ã‚’ã—ã¦ãŠãã¨ç¢ºå®Ÿã«arenaã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒfd/bkã«æ›¸ãè¾¼ã¾ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã€å¾ŒåŠã®å‹•ä½œã€‘

p = malloc(MALLOC_SIZE); // å†åº¦mallocã§åŒã˜ã‚µã‚¤ã‚º
c = mem2chunk(p);

// æƒ…å ±ãƒªãƒ¼ã‚¯ï¼ˆUninitializedåˆ©ç”¨ï¼‰

    freeã—ãŸç›´å¾Œã«åŒã˜ã‚µã‚¤ã‚ºã§mallocã™ã‚‹ã¨ã€åŒã˜ãƒãƒ£ãƒ³ã‚¯ãŒå†åˆ©ç”¨ã•ã‚Œã‚‹ã€‚

    malloc_chunkæ§‹é€ ä½“ã®fd/bkã¯ä¸Šæ›¸ãã•ã‚Œãšæ®‹ã£ã¦ã„ã‚‹ã“ã¨ãŒå¤šã„ãŸã‚ã€åˆæœŸåŒ–ã•ã‚Œãªã„ã¾ã¾ã®ãƒ‡ãƒ¼ã‚¿ãŒãã®ã¾ã¾ä½¿ãˆã‚‹ã€‚

    ã“ã®ç¾è±¡ã‚’Uninitialized memory leakã¨å‘¼ã³ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«ã¯æ·±åˆ»ãªæƒ…å ±æ¼æ´©è¦å› ã«ãªã‚Šã¾ã™ã€‚

ğŸ§  æ”»æ’ƒçš„æ„ç¾©

ã“ã®ã‚ˆã†ãªæŠ€è¡“ã¯CTFã‚„å®Ÿè·µçš„ãªãƒ’ãƒ¼ãƒ—ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã§é‡è¦ã§ã™ï¼š

    libc baseãŒåˆ†ã‹ã‚Œã°ã€systemã‚„__free_hookãªã©ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç‰¹å®šã§ãã‚‹

    heap baseãŒåˆ†ã‹ã‚Œã°ã€ãƒ’ãƒ¼ãƒ—ã‚¹ãƒ—ãƒ¬ãƒ¼ã‚„fake chunkãªã©ãŒå¯èƒ½ã«

ğŸ”š ã¾ã¨ã‚
é …ç›®	å†…å®¹
malloc_struct.h	glibc malloc ã®ãƒãƒ£ãƒ³ã‚¯æ§‹é€ ä½“ã‚’æ¨¡å€£ã—ãŸå®šç¾©
malloc(0)	arenaåˆæœŸåŒ–ã®ãŸã‚ã€‚fd/bkã«libcã®ãƒã‚¤ãƒ³ã‚¿ãŒå…¥ã‚‹ã‚ˆã†ã«ã™ã‚‹
ca->fd / ca->bk	main_arenaã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å«ã¿ã€libc baseã®æ¨å®šã«ä½¿ãˆã‚‹
Uninitialized	åˆæœŸåŒ–ã•ã‚Œãªã„ãƒ’ãƒ¼ãƒ—é ˜åŸŸã®å†åˆ©ç”¨ã«ã‚ˆã‚Šæƒ…å ±ãŒãƒªãƒ¼ã‚¯ã™ã‚‹
ã‚ªãƒ•ã‚»ãƒƒãƒˆ	0x6d0ã‚„0x60ã¯glibcã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¾å­˜ã§èª¿æ•´ãŒå¿…è¦

å¿…è¦ãªã‚‰ã€glibcãƒ’ãƒ¼ãƒ—æ§‹é€ ã®å›³è§£ã‚„main_arenaã®ãƒã‚¤ãƒŠãƒªä¸Šã®æ§˜å­ã‚‚è£œè¶³ã§ãã¾ã™ã€‚
Let me know if you'd like a heap structure diagram or glibc arena layout explanationã€‚
